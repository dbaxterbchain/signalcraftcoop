generator client {
  provider        = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum OrderType {
  custom
  store
}

enum OrderStatus {
  intake
  designing
  review
  approved
  production
  shipping
  complete
  on_hold
  canceled
}

enum PaymentStatus {
  unpaid
  authorized
  paid
  refunded
  disputed
}

enum DesignStatus {
  draft
  in_review
  changes_requested
  approved
}

enum DesignReviewStatus {
  approved
  changes_requested
}

enum ContactStatus {
  open
  closed
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  phone     String?
  role      String   @default("customer")
  orders    Order[]
  addresses Address[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Address {
  id         String   @id @default(uuid())
  userId     String
  label      String   @default("shipping")
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String
  country    String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
}

model Order {
  id              String        @id @default(uuid())
  userId          String?
  orderNumber     String        @unique
  type            OrderType
  status          OrderStatus
  paymentStatus   PaymentStatus @default(unpaid)
  paymentRequiredAt DateTime?
  paidAt          DateTime?
  paymentProvider String?
  paymentReference String?
  paymentMethod   String?
  subtotal        Float
  tax             Float
  shipping        Float
  total           Float
  shippingAddress Json?
  billingAddress  Json?
  shippingCarrier String?
  shippingService String?
  trackingNumber  String?
  trackingUrl     String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  items           OrderItem[]
  designs         Design[]
  events          OrderEvent[]
  user            User?         @relation(fields: [userId], references: [id])
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model OrderItem {
  id          String    @id @default(uuid())
  orderId     String
  productId   String?
  title       String
  sku         String?
  quantity    Int
  unitPrice   Float
  metadata    Json?
  nfcConfigId String?   @unique
  designId    String?
  order       Order     @relation(fields: [orderId], references: [id])
  product     Product?  @relation(fields: [productId], references: [id])
  nfcConfig   NFCConfig? @relation(fields: [nfcConfigId], references: [id])
}

model Product {
  id         String    @id @default(uuid())
  title      String
  sku        String    @unique
  description String?
  basePrice  Float
  category   String?
  allowsNfc  Boolean   @default(false)
  allowsLogoUpload Boolean @default(false)
  active     Boolean   @default(true)
  images     ProductImage[]
  items      OrderItem[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  url       String
  isMain    Boolean  @default(false)
  sortOrder Int      @default(0)
  altText   String?
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model Design {
  id        String       @id @default(uuid())
  orderId   String
  version   Int
  status    DesignStatus
  previewUrl String
  sourceUrl  String?
  order     Order        @relation(fields: [orderId], references: [id])
  reviews   DesignReview[]
  createdAt DateTime     @default(now())
}

model DesignReview {
  id           String             @id @default(uuid())
  designId     String
  status       DesignReviewStatus
  comment      String?
  attachmentUrl String?
  design       Design             @relation(fields: [designId], references: [id])
  createdAt    DateTime           @default(now())
}

model OrderEvent {
  id          String   @id @default(uuid())
  orderId     String
  type        String
  title       String
  description String?
  metadata    Json?
  isCustomerVisible Boolean @default(true)
  createdBy   String?
  order       Order    @relation(fields: [orderId], references: [id])
  createdAt   DateTime @default(now())
}

model ContactMessage {
  id        String        @id @default(uuid())
  name      String
  email     String
  subject   String?
  message   String
  status    ContactStatus @default(open)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model NFCConfig {
  id        String   @id @default(uuid())
  url       String
  kind      String?
  notes     String?
  item      OrderItem?
  createdAt DateTime @default(now())
}
